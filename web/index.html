<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>
		
		<!-- JQuery -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.1/jquery.min.js"></script>
		
		<!-- Pyscript -->
		<script defer src="https://pyscript.net/latest/pyscript.js"></script>
		<link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />

		<!-- jstree -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
		<!-- they have an interresting style over there -->
		<!-- https://preview.keenthemes.com/html/metronic/docs/general/jstree/overview -->

		<style>
			#jstree-container .folder { background:url('https://www.jstree.com/demo_filebrowser/file_sprite.png') right bottom no-repeat; }
			#jstree-container .file { background:url('https://www.jstree.com/demo_filebrowser/file_sprite.png') 0 0 no-repeat; }
		</style>
	</head>

	<body>

		<div>
			<textarea id="schema-input" placeholder="Write the schema here"></textarea>
			<p id="schema-parse-error"></p>
		</div>

		<div>
			<div id="jstree-container">
				<ul>
					<li data-jstree='{"type":"default"}'>
						root
						<ul>
							<li data-jstree='{"type":"file"}'>file1</li>
							<li data-jstree='{"type":"file"}'>file2</li>
							<li data-jstree='{"type":"file"}'>file3</li>
							<li data-jstree='{"type":"default"}'>
								folder
								<ul>
									<li data-jstree='{"type":"default"}'>asdwasd</li>
								</ul>
							</li>
						</ul>
					</li>
				</ul>
			</div>
			<p id="validation-error"></p>
		</div>

		<!-- <button py-click="do_the_validation()" id="do-the-validation" class="py-button">Do the validation</button> -->
		<button onclick="doTheValidation()" class="py-button">Do the validation</button>

		<div id="ko-fi-button">
			<script type='text/javascript' src='https://storage.ko-fi.com/cdn/widget/Widget_2.js'></script><script type='text/javascript'>kofiwidget2.init('Support Me on Ko-fi', '#d136ba', 'M4M3CMENQ');kofiwidget2.draw();</script> 
		</div>

		<py-config>
			packages = ["matplotlib", "pandas", "pathschema==0.2.0"]
		</py-config>
		<py-script>

			from pathlib import Path
			from datetime import datetime
			import os
			import tempfile
			import shutil

			from pathschema import validate
			from pathschema.models import DirPathNode

			# elements
			schema_input_element = Element('schema-input')
			schema_parse_error_element = Element('schema-parse-error')
			validation_error_element = Element('validation-error')

			temp_dir = Path(tempfile.gettempdir())
			folder_to_validate = 'root'

			def validate_the_files_with_schema():

				results = None

				try:
					# get the schema from the input element
					schema = schema_input_element.value

					# do the validation
					results = validate(temp_dir / folder_to_validate, schema)

				except SchemaError as e:
					# Error in the user schema
					schema_parse_error_element.write(str(e))
					return
				except Exception as e:
					# Other exceptions
					print(str(e))
					return

				if(results.has_error()):
					show_validation_errors(results)
				else:
					clear_validation_errors()
					# TODO: show success?
			
			def clear_validation_errors():
				validation_error_element.clear()
			
			def show_validation_errors(results):
				text = ''

				for path, errors in results.errors_by_path.items():
					if(len(errors) > 0 ):
						text += 'FAIL  '
					else:
						text += '&nbsp;&nbsp;OK    '

					text += str(path) + '\n'
					
					for error in errors:
						text += '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + error + '\n'
				
				validation_error_element.clear()
				for line in text.split('\n'):
					validation_error_element.write(line, append=True)


			def set_folder_to_validate(name):
				global folder_to_validate
				folder_to_validate = name

			def create_fake_file(path):
				print('creating file ' + path)
				full_path = temp_dir / path
				os.makedirs(full_path.parent, exist_ok=True)
				full_path.touch()

			def create_fake_dir(path):
				print('creating dir ' + path)
				os.makedirs(temp_dir / path, exist_ok=True)

			def clear_paths():
				shutil.rmtree(temp_dir)


		</py-script>

		<script>
			$(function () {
				$('#jstree-container').jstree({
					'core': {
						'check_callback' : function(o, n, p, i, m) {
							// operation, node, node_parent, node_position, more
							
							if(m && m.dnd && m.pos !== 'i') { return false; }
							if(o === "move_node" || o === "copy_node") {
								if(this.get_node(n).parent === this.get_node(p).id) { return false; }
							}

							// prevent the root node from being deleted
							if (o === 'delete_node' && n.id === 'j1_1') {
								return false;
							}
							return true;
						},
						'themes' : {
							'responsive' : false,
							'variant' : 'small',
							'stripes' : true
						},
					},
					'sort' : function(a, b) {
						return this.get_type(a) === this.get_type(b) ? (this.get_text(a) > this.get_text(b) ? 1 : -1) : (this.get_type(a) >= this.get_type(b) ? 1 : -1);
					},
					'contextmenu' : {
						'items' : function(node) {
							var tmp = $.jstree.defaults.contextmenu.items();
							delete tmp.create.action;
							tmp.create.label = "New";
							tmp.create.submenu = {
								"create_folder" : {
									"separator_after" : true,
									"label" : "Folder",
									"action" : function (data) {
										var inst = $.jstree.reference(data.reference),
											obj = inst.get_node(data.reference);
										inst.create_node(obj, { type : "default" }, "last", function (new_node) {
											setTimeout(function () { inst.edit(new_node); },0);
										});
									}
								},
								"create_file" : {
									"label" : "File",
									"action" : function (data) {
										var inst = $.jstree.reference(data.reference),
											obj = inst.get_node(data.reference);
										inst.create_node(obj, { type : "file" }, "last", function (new_node) {
											setTimeout(function () { inst.edit(new_node); },0);
										});
									}
								}
							};
							if(this.get_type(node) === "file") {
								delete tmp.create;
							}
							return tmp;
						}
					},
					'types' : {
						'default' : { 'icon' : 'folder' },
						'file' : { 'valid_children' : [], 'icon' : 'file' }
					},
					'unique' : {
						'duplicate' : function (name, counter) {
							return name + ' ' + counter;
						}
					},
					'plugins' : ['state', 'dnd', 'sort', 'types', 'contextmenu', 'unique']
				});

				$('#jstree-container').on('changed.jstree', function (e, data) {
					// console.log(data.selected);
				});

			});

			function printNode(node) {
				console.log(node.text.trim(), node);
				if(node.children.length > 0) {
					node.children.forEach(childId => {
						const childNode = $('#jstree-container').jstree(true).get_node(childId);
						printNode(childNode);
					});
				}
			}

			function createPathsFromNodes(node, parentName = null) {
				let name = node.text.trim()

				if(parentName != null) {
					name = parentName + '/' + name
				}
				
				if(node.type == 'file') {
					// create the file
					pyscript.interpreter.globals.get('create_fake_file')(name);
				}
				else {
					// create the directory
					pyscript.interpreter.globals.get('create_fake_dir')(name);
				}
				
				if(node.children.length > 0) {
					node.children.forEach(childId => {
						const childNode = $('#jstree-container').jstree(true).get_node(childId);
						createPathsFromNodes(childNode, name);
					});
				}
			}

			function doTheValidation() {

				const rootNode = $('#jstree-container').jstree(true).get_node('j1_1');
				
				// update the name of the folder to validate
				pyscript.interpreter.globals.get('set_folder_to_validate')(rootNode.text.trim());

				// clear all paths
				pyscript.interpreter.globals.get('clear_paths')();

				// create all new paths
				createPathsFromNodes(rootNode)
				
				// start the validation
				pyscript.interpreter.globals.get('validate_the_files_with_schema')();
			}

		</script>

	</body>

</html>
